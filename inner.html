<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <style>
        #quiz-content {
            max-width: 600px;
            height: 100%;
            display: flex;
            flex-flow: column;
            align-items: center;
            justify-content: flex-start;

            gap: 4rem;

            overflow-y: scroll;
            overflow-x: hidden;
        }

        #quiz-content > * {
            display: none;
            width: 100%;
        }

        .quiz_question {
            display: flex;
            flex-flow: column;
            align-items: center;
            justify-content: space-between;

            gap: 1rem;
            padding: 2rem;
            border: 2px solid black;
            border-radius: 10px;
        }

        .quiz_question__lower {
            width: 100%;

            display: flex;
            flex-flow: row;
            align-items: center;
            justify-content: space-evenly;
        }

        .quiz_question__explanation {
            display: none;
        }

    </style>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            let quizContent = document.getElementById('quiz-content');


            // Control of taking a step is built using events
            const next = new Event("next");
            document.getElementById('quiz-button').addEventListener("click", () => {
                console.log("dispatching event")
                document.dispatchEvent(next);
            });
    
    
            // This will be generated by the backend
            let quizes = [{"id": "quiz_1", "type": "radio", "answer": 0}, {"id": "quiz_2", "type": "checkbox", "answer": [0, 2]}];
            const getQuizObj = (id) => {
                return quizes.find(quiz => quiz.id === id);
            }
    
    
            // This will be changed by the user depending on what he wants to do
            const endFunction = () => {
                console.log("You ended the quiz")
            }
    
    
            // --- helpers to retrieve answer from quizes
            // return single int
            const getRadioAnswer = (content) => {
                const lower = content.querySelector(".quiz_question__lower");
                for (const input of lower.children) {
                    if (input.checked) {
                        return input.value;
                    }
                }
            }
    
    
            // returns array of int
            const getCheckboxAnswer = (content) => {
                const lower = content.querySelector(".quiz_question__lower");
                let answers = [];
                for (const input of lower.children) {
                    if (input.checked) {
                        answers.push(input.value);
                    }
                }
                return answers;
            }
    

            // --- helper to show explanation and block further input
            const finishQuestion  = (content) => {
                const explanation = content.querySelector(".quiz_question__explanation");
                explanation.style.display = "flex";
                const lower = content.querySelector(".quiz_question__lower");
                for (const input of lower.children) {
                    input.disabled = true;
                }
            }
    

            // taking a step
            const revealOneAndBuildButton = () => {
                //console.log("Step function triggere")
                for (let i = 0; i < quizContent.children.length; i++) {
                    const content = quizContent.children[i];
                    if (window.getComputedStyle(content).display === "none") {
                        //console.log("Display is none, revealing")
                        console.log(content)
    
                        // revealing one more content
                        content.style.display = "block";
    
                        // building the new button
                        let button = document.createElement("button");
                        button.id = "quiz-button";
                        if (i === quizContent.children.length - 1) {
                            //console.log("finish button")
                            button.innerHTML = "Finish Quiz";
                        } else {
                            //console.log("next button")
                            button.innerHTML = "Next";
                        }
    
    
                        // check if content is a p or img tag
                        if ((content.tagName === "P" && content.className === "quiz_text") || (content.tagName === "IMG" && content.className === "quiz_img")) {
                            console.log("Static Content")

                            button.addEventListener("click", () => {
                                document.dispatchEvent(next);
                            });
                        } 

                        else if (content.tagName === "DIV" && content.className === "quiz_question") {
                            console.log("Question Content")
                            
                            button.addEventListener("click", () => {
                                const content_id = content.id;
                                const quiz_obj = getQuizObj(content_id);
                                let user_answer

                                
                                if (quiz_obj.type === "checkbox") {
                                    user_answer = getCheckboxAnswer(content);
                                } else if (quiz_obj.type === "radio") {
                                    user_answer = getRadioAnswer(content);
                                } else {
                                    console.log("Error: Unknown type of quiz")
                                }
    

                                console.log(user_answer, quiz_obj.answer);


                                // TODO: only continuer if correct
                                if (user_answer == quiz_obj.answer) {
                                    console.log("Correct");
                                } else {
                                    console.log("Incorrect");
                                }


                                finishQuestion(content);
                                document.dispatchEvent(next);
                            });
                        }
    
                        // replacing the button
                        const quizButton = document.getElementById('quiz-button');
                        quizButton.parentNode.replaceChild(button, quizButton);
                        return;
                    }
                }
                endFunction();
            }


            // listening for event
            document.addEventListener("next", () => {
                //console.log("Next event is triggered");
                revealOneAndBuildButton();
            });
        })
    </script>
    <main id="quiz">
        <div id="quiz-content">
            <!-- text -->
            <p class="quiz_text">Today is tuesday</p>

            <!-- radio -->
            <div class="quiz_question" id="quiz_1">
                <h5 class="quiz_question__upper">What day is today (choose one)</h5>
                <div class="quiz_question__lower">
                    <input type="radio" name="quiz_1" value="0"> Tuesday
                    <input type="radio" name="quiz_1" value="1"> Wednesday
                    <input type="radio" name="quiz_1" value="2"> Thursday
                </div>
                <div class="quiz_question__explanation">
                    <p>Explanation: Today is Tuesday</p>
                </div>
            </div>

            <!-- image -->
            <img class="quiz_img" src="/static/fname.png" alt="an image">

            <!-- checkbox -->
            <div class="quiz_question" id="quiz_2">
                <h5 class="quiz_question__upper">What colors are in the picture (choose all that apply)</h5>
                <div class="quiz_question__lower">
                    <input type="checkbox" name="quiz_1" value="0"> Red
                    <input type="checkbox" name="quiz_1" value="1"> Blue
                    <input type="checkbox" name="quiz_1" value="2"> Green
                </div>

                <div class="quiz_question__explanation">
                    <p>Explanation: The picture has a red flower and a green leaf</p>
                </div>
            </div>
        </div>

        <button id="quiz-button">
            Start
        </button>
    </main>
</body>
</html>